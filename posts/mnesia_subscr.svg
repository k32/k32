<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2479px" preserveAspectRatio="none" style="width:1171px;height:2479px;" version="1.1" viewBox="0 0 1171 2479" width="1171px" zoomAndPan="magnify"><defs><filter height="300%" id="fr9oizoz0xu4c" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" height="2464.6149" style="stroke: #A80036; stroke-width: 1.0;" width="631.5" x="123" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89" x="394.25" y="17.897">Original node</text><rect fill="#ADD8E6" height="2464.6149" style="stroke: #A80036; stroke-width: 1.0;" width="402" x="756.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86" x="914.5" y="17.897">Participant A</text><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="2132.2429" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="137" y="105.4799"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="1953.4189" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="142" y="239.598"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="137.5301" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="147" y="343.716"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="246.9421" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="147" y="618.3642"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="689.7083" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="147" y="1273.0725"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="343.3541" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="152" y="1574.7206"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="190.2361" style="stroke: #000000; stroke-width: 2.0;" width="937" x="117" y="638.3642"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="152.5301" style="stroke: #000000; stroke-width: 2.0;" width="791" x="117" y="1037.1304"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="150.8241" style="stroke: #000000; stroke-width: 2.0;" width="365" x="705" y="2259.7229"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="142" x2="142" y1="63.7739" y2="2427.547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="448.5" x2="448.5" y1="63.7739" y2="2427.547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="560.5" x2="560.5" y1="63.7739" y2="2427.547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="688.5" x2="688.5" y1="63.7739" y2="2427.547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="805.5" x2="805.5" y1="63.7739" y2="2427.547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1097.5" x2="1097.5" y1="63.7739" y2="2427.547"/><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="26" x="127" y="25.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="12" x="134" y="47.672">tx</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="26" x="127" y="2426.547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="12" x="134" y="2448.5129">tx</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="403.5" y="25.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="410.5" y="47.672">mnesia_tm</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="403.5" y="2426.547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="410.5" y="2448.5129">mnesia_tm</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="504.5" y="25.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="511.5" y="47.672">mnesia_locker</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="504.5" y="2426.547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="511.5" y="2448.5129">mnesia_locker</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="119" x="627.5" y="25.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="634.5" y="47.672">mnesia_recover</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="119" x="627.5" y="2426.547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="634.5" y="2448.5129">mnesia_recover</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="760.5" y="25.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="767.5" y="47.672">mnesia_tm</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="760.5" y="2426.547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="767.5" y="2448.5129">mnesia_tm</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="1041.5" y="25.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1048.5" y="47.672">mnesia_locker</text><rect fill="#FEFECE" filter="url(#fr9oizoz0xu4c)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="1041.5" y="2426.547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1048.5" y="2448.5129">mnesia_locker</text><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="2132.2429" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="137" y="105.4799"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="1953.4189" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="142" y="239.598"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="137.5301" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="147" y="343.716"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="246.9421" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="147" y="618.3642"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="689.7083" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="147" y="1273.0725"/><rect fill="#FFFFFF" filter="url(#fr9oizoz0xu4c)" height="343.3541" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="152" y="1574.7206"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="142" x2="189" y1="92.4799" y2="92.4799"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="189" x2="189" y1="92.4799" y2="105.4799"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148" x2="189" y1="105.4799" y2="105.4799"/><polygon fill="#A80036" points="158,101.4799,148,105.4799,158,109.4799,154,105.4799" style="stroke: #A80036; stroke-width: 1.0;"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1094" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1094" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1094" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1094" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="126" x="154" y="86.6709">mnesia_tm:t_commit</text></a><line style="stroke: #A80036; stroke-width: 1.0;" x1="147" x2="189" y1="142.186" y2="142.186"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="189" x2="189" y1="142.186" y2="155.186"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148" x2="189" y1="155.186" y2="155.186"/><polygon fill="#A80036" points="158,151.186,148,155.186,158,159.186,154,155.186" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="154" y="136.377">mnesia_tm:intercept_friends</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="147" x2="189" y1="186.892" y2="186.892"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="189" x2="189" y1="186.892" y2="199.892"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148" x2="189" y1="199.892" y2="199.892"/><polygon fill="#A80036" points="158,195.892,148,199.892,158,203.892,154,199.892" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="154" y="181.083">mnesia_tm:arrange</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="147" x2="194" y1="226.598" y2="226.598"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194" x2="194" y1="226.598" y2="239.598"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="153" x2="194" y1="239.598" y2="239.598"/><polygon fill="#A80036" points="163,235.598,153,239.598,163,243.598,159,239.598" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="159" y="220.789">mnesia_tm:multi_commit(Prep)</text><path d="M8,257.598 L8,302.598 L272,302.598 L272,267.598 L262,257.598 L8,257.598 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M262,257.598 L262,267.598 L272,267.598 L262,257.598 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="14" y="276.495">Mnesia has 4 different commit protocols.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="14" y="294.201">We only consider</text><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1380" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1380" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1380" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1380" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="62" x="119" y="294.201">sym_trans</text></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="184" y="294.201">here.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="199" y1="330.716" y2="330.716"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="199" x2="199" y1="330.716" y2="343.716"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="158" x2="199" y1="343.716" y2="343.716"/><polygon fill="#A80036" points="168,339.716,158,343.716,168,347.716,164,343.716" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="164" y="324.907">mnesia_tm:commit_nodes</text><path d="M43,361.716 L43,441.716 L236,441.716 L236,371.716 L226,361.716 L43,361.716 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M226,361.716 L226,371.716 L236,371.716 L226,361.716 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="49" y="380.6131">Get list of nodes that contain</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="49" y="398.3191">disk and ram copies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="49" y="416.0251">of tables affected by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="49" y="433.7311">the transaction</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="157" x2="199" y1="480.2461" y2="480.2461"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="199" x2="199" y1="480.2461" y2="493.2461"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="152" x2="199" y1="493.2461" y2="493.2461"/><polygon fill="#A80036" points="162,489.2461,152,493.2461,162,497.2461,158,493.2461" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="164" y="474.4371">{DiskNs, RamNs}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="194" y1="519.9521" y2="519.9521"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194" x2="194" y1="519.9521" y2="532.9521"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="153" x2="194" y1="532.9521" y2="532.9521"/><polygon fill="#A80036" points="163,528.9521,153,532.9521,163,536.9521,159,532.9521" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="159" y="514.1431">mnesia_checkpoint:tm_enter_pending</text><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1156.5" x="3" y="562.8052"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="562.8052" y2="562.8052"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="565.8052" y2="565.8052"/><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="120" x="521.25" y="550.9521"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="527.25" y="568.8492">1st phase of 2PC</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="199" y1="605.3642" y2="605.3642"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="199" x2="199" y1="605.3642" y2="618.3642"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="158" x2="199" y1="618.3642" y2="618.3642"/><polygon fill="#A80036" points="168,614.3642,158,618.3642,168,622.3642,164,618.3642" style="stroke: #A80036; stroke-width: 1.0;"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2071" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2071" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2071" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2071" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="141" x="164" y="599.5552">mnesia_tm:ask_commit</text></a><path d="M117,638.3642 L190,638.3642 L190,647.3642 L180,657.3642 L117,657.3642 L117,638.3642 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="190.2361" style="stroke: #000000; stroke-width: 2.0;" width="937" x="117" y="638.3642"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="132" y="653.2612">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="196" x="205" y="652.1231">[for each #commit record in #prep]</text><polygon fill="#A80036" points="794,677.7762,804,681.7762,794,681.7762" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="805" y1="681.7762" y2="681.7762"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L248" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L248" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L248" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L248" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="72" x="164" y="675.9672">ask_commit</text></a><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="713.4822" y2="713.4822"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="713.4822" y2="726.4822"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="726.4822" y2="726.4822"/><polygon fill="#A80036" points="817,722.4822,807,726.4822,817,730.4822,813,726.4822" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="813" y="707.6732">mnesia_checkpoint:tm_enter_pending</text><polygon fill="#A80036" points="168,754.1882,158,758.1882,168,758.1882" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="805" y1="758.1882" y2="758.1882"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="174" y="752.3792">{vote_yes, Tid}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="807.6003" y2="807.6003"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="807.6003" y2="820.6003"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="820.6003" y2="820.6003"/><polygon fill="#A80036" points="817,816.6003,807,820.6003,817,824.6003,813,820.6003" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="813" y="784.0853">Add commit record from tx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="813" y="801.7913">to the state gb_tree</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="157" x2="199" y1="864.3063" y2="864.3063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="199" x2="199" y1="864.3063" y2="877.3063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="152" x2="199" y1="877.3063" y2="877.3063"/><polygon fill="#A80036" points="162,873.3063,152,877.3063,162,881.3063,158,877.3063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="164" y="858.4973">{WaitFor, Local}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="194" y1="904.0123" y2="904.0123"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194" x2="194" y1="904.0123" y2="917.0123"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="153" x2="194" y1="917.0123" y2="917.0123"/><polygon fill="#A80036" points="163,913.0123,153,917.0123,163,921.0123,159,917.0123" style="stroke: #A80036; stroke-width: 1.0;"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2097" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2097" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2097" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2097" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="244" x="159" y="898.2033">receive nodes' votes and derive outcome</text></a><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1156.5" x="3" y="946.8653"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="946.8653" y2="946.8653"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="949.8653" y2="949.8653"/><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="125" x="518.75" y="935.0123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="524.75" y="952.9093">2nd phase of 2PC</text><path d="M51,975.7183 L51,1020.7183 L228,1020.7183 L228,985.7183 L218,975.7183 L51,975.7183 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M218,975.7183 L218,985.7183 L228,985.7183 L218,975.7183 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="57" y="994.6153">broadcast the outcome to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="60" y="1012.3214">the participants</text><path d="M117,1037.1304 L190,1037.1304 L190,1046.1304 L180,1056.1304 L117,1056.1304 L117,1037.1304 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="152.5301" style="stroke: #000000; stroke-width: 2.0;" width="791" x="117" y="1037.1304"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="132" y="1052.0274">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="205" y="1050.8893">[for each participant node]</text><polygon fill="#A80036" points="794,1076.5424,804,1080.5424,794,1080.5424" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="805" y1="1080.5424" y2="1080.5424"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="159" y="1074.7334">{Tid, Outcome = do_commit}</text><path d="M765,1093.5424 L765,1120.5424 L843,1120.5424 L843,1103.5424 L833,1093.5424 L765,1093.5424 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M833,1093.5424 L833,1103.5424 L843,1103.5424 L833,1093.5424 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L273" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L273" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L273" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L273" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="57" x="771" y="1112.4394">doit_loop</text></a><path d="M713,1135.2484 L713,1180.2484 L894,1180.2484 L894,1145.2484 L884,1135.2484 L713,1135.2484 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M884,1135.2484 L884,1145.2484 L894,1145.2484 L884,1135.2484 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="719" y="1154.1454">lookup #participant record</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="722" y="1171.8514">from the state gb_tree</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="194" y1="1220.3665" y2="1220.3665"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194" x2="194" y1="1220.3665" y2="1233.3665"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="153" x2="194" y1="1233.3665" y2="1233.3665"/><polygon fill="#A80036" points="163,1229.3665,153,1233.3665,163,1237.3665,159,1233.3665" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="159" y="1214.5575">mnesia_recover:note_decision(Tid, committed)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="199" y1="1260.0725" y2="1260.0725"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="199" x2="199" y1="1260.0725" y2="1273.0725"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="158" x2="199" y1="1273.0725" y2="1273.0725"/><polygon fill="#A80036" points="168,1269.0725,158,1273.0725,168,1277.0725,164,1273.0725" style="stroke: #A80036; stroke-width: 1.0;"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1777" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1777" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1777" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1777" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="119" x="164" y="1254.2635">mnesia_tm:do_dirty</text></a><path d="M44,1291.0725 L44,1354.0725 L235,1354.0725 L235,1301.0725 L225,1291.0725 L44,1291.0725 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M225,1291.0725 L225,1301.0725 L235,1301.0725 L225,1291.0725 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="50" y="1309.9695">Mnesia logs #commit record</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="50" y="1327.6755">for the local node.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="50" y="1345.3815">See "Arrange" chapter below</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="199" y1="1386.8965" y2="1386.8965"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="199" x2="199" y1="1386.8965" y2="1399.8965"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="158" x2="199" y1="1399.8965" y2="1399.8965"/><polygon fill="#A80036" points="168,1395.8965,158,1399.8965,168,1403.8965,164,1399.8965" style="stroke: #A80036; stroke-width: 1.0;"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_log.erl#L227" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_log.erl#L227" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_log.erl#L227" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_log.erl#L227" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="90" x="164" y="1381.0875">mnesia_log:log</text></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="254" y="1381.0875">(#commit{})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="1431.6026" y2="1431.6026"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="1431.6026" y2="1444.6026"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="1444.6026" y2="1444.6026"/><polygon fill="#A80036" points="817,1440.6026,807,1444.6026,817,1448.6026,813,1444.6026" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="813" y="1425.7936">mnesia_log:log(Commit)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="1476.3086" y2="1476.3086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="1476.3086" y2="1489.3086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="1489.3086" y2="1489.3086"/><polygon fill="#A80036" points="817,1485.3086,807,1489.3086,817,1493.3086,813,1489.3086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="813" y="1470.4996">mnesia_recover:note_decision(Tid, committed)</text><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1156.5" x="3" y="1519.1616"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="1519.1616" y2="1519.1616"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="1522.1616" y2="1522.1616"/><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="151" x="505.75" y="1507.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="511.75" y="1525.2056">Post-commit actions</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="204" y1="1561.7206" y2="1561.7206"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204" x2="204" y1="1561.7206" y2="1574.7206"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163" x2="204" y1="1574.7206" y2="1574.7206"/><polygon fill="#A80036" points="173,1570.7206,163,1574.7206,173,1578.7206,169,1574.7206" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="169" y="1555.9116">mnesia_tm:do_commit</text><path d="M56,1592.7206 L56,1655.7206 L224,1655.7206 L224,1602.7206 L214,1592.7206 L56,1592.7206 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M214,1592.7206 L214,1602.7206 L224,1602.7206 L214,1592.7206 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="62" y="1611.6176">Dump the ops to the DB,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="65" y="1629.3236">notify subscribers,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="65" y="1647.0297">etc.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="162" x2="204" y1="1688.5447" y2="1688.5447"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204" x2="204" y1="1688.5447" y2="1701.5447"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163" x2="204" y1="1701.5447" y2="1701.5447"/><polygon fill="#A80036" points="173,1697.5447,163,1701.5447,173,1705.5447,169,1701.5447" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="169" y="1682.7357">mnesia_tm:do_snmp</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="162" x2="204" y1="1733.2507" y2="1733.2507"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204" x2="204" y1="1733.2507" y2="1746.2507"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163" x2="204" y1="1746.2507" y2="1746.2507"/><polygon fill="#A80036" points="173,1742.2507,163,1746.2507,173,1750.2507,169,1746.2507" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="169" y="1727.4417">update_ram_copies</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="162" x2="204" y1="1777.9567" y2="1777.9567"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204" x2="204" y1="1777.9567" y2="1790.9567"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163" x2="204" y1="1790.9567" y2="1790.9567"/><polygon fill="#A80036" points="173,1786.9567,163,1790.9567,173,1794.9567,169,1790.9567" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="169" y="1772.1477">update_disc_copies</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="162" x2="204" y1="1822.6627" y2="1822.6627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204" x2="204" y1="1822.6627" y2="1835.6627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163" x2="204" y1="1835.6627" y2="1835.6627"/><polygon fill="#A80036" points="173,1831.6627,163,1835.6627,173,1839.6627,169,1835.6627" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="169" y="1816.8537">mnesia_tm:do_update_ext</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="162" x2="204" y1="1867.3687" y2="1867.3687"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204" x2="204" y1="1867.3687" y2="1880.3687"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163" x2="204" y1="1880.3687" y2="1880.3687"/><polygon fill="#A80036" points="173,1876.3687,163,1880.3687,173,1884.3687,169,1880.3687" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="169" y="1861.5597">mnesia_subscr:report_activity</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="162" x2="204" y1="1917.0748" y2="1917.0748"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="204" x2="204" y1="1917.0748" y2="1930.0748"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="157" x2="204" y1="1930.0748" y2="1930.0748"/><polygon fill="#A80036" points="167,1926.0748,157,1930.0748,167,1934.0748,163,1930.0748" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="6" x="169" y="1911.2658">?</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="157" x2="199" y1="1961.7808" y2="1961.7808"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="199" x2="199" y1="1961.7808" y2="1974.7808"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="152" x2="199" y1="1974.7808" y2="1974.7808"/><polygon fill="#A80036" points="162,1970.7808,152,1974.7808,162,1978.7808,158,1974.7808" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="6" x="164" y="1955.9718">?</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="2001.4868" y2="2001.4868"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="2001.4868" y2="2014.4868"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="2014.4868" y2="2014.4868"/><polygon fill="#A80036" points="817,2010.4868,807,2014.4868,817,2018.4868,813,2014.4868" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="813" y="1995.6778">mnesia_tm:do_commit(Tid, Commit)</text><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1156.5" x="3" y="2044.3398"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="2044.3398" y2="2044.3398"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1159.5" y1="2047.3398" y2="2047.3398"/><rect fill="#EEEEEE" filter="url(#fr9oizoz0xu4c)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="71" x="545.75" y="2032.4868"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="551.75" y="2050.3838">Cleanup</text><polygon fill="#A80036" points="549,2087.8988,559,2091.8988,549,2095.8988,553,2091.8988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="555" y1="2091.8988" y2="2091.8988"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="64" x="159" y="2086.0898">release_tid</text></a><polygon fill="#A80036" points="1086,2119.6048,1096,2123.6048,1086,2127.6048,1090,2123.6048" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="1092" y1="2123.6048" y2="2123.6048"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="64" x="813" y="2117.7958">release_tid</text></a><polygon fill="#A80036" points="437,2151.3109,447,2155.3109,437,2155.3109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="152" x2="448" y1="2155.3109" y2="2155.3109"/><a href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L377" target="_top" title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L377" xlink:actuate="onRequest" xlink:href="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L377" xlink:show="new" xlink:title="https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L377" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="111" x="159" y="2149.5019">delete_transaction</text></a><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="152" x2="194" y1="2192.0169" y2="2192.0169"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="194" x2="194" y1="2192.0169" y2="2205.0169"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="147" x2="194" y1="2205.0169" y2="2205.0169"/><polygon fill="#A80036" points="157,2201.0169,147,2205.0169,157,2209.0169,153,2205.0169" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="159" y="2186.2079">do_commit</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="147" x2="189" y1="2236.7229" y2="2236.7229"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="189" x2="189" y1="2236.7229" y2="2249.7229"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="142" x2="189" y1="2249.7229" y2="2249.7229"/><polygon fill="#A80036" points="152,2245.7229,142,2249.7229,152,2253.7229,148,2249.7229" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="154" y="2230.9139">do_commit</text><path d="M705,2259.7229 L855,2259.7229 L855,2268.7229 L845,2278.7229 L705,2278.7229 L705,2259.7229 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="150.8241" style="stroke: #000000; stroke-width: 2.0;" width="365" x="705" y="2259.7229"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="720" y="2274.6199">remote cleanup</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="2303.1349" y2="2303.1349"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="2303.1349" y2="2316.1349"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="2316.1349" y2="2316.1349"/><polygon fill="#A80036" points="817,2312.1349,807,2316.1349,817,2320.1349,813,2316.1349" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="813" y="2297.3259">mnesia_tm:transaction_terminated</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="806" x2="848" y1="2347.8409" y2="2347.8409"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848" x2="848" y1="2347.8409" y2="2360.8409"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807" x2="848" y1="2360.8409" y2="2360.8409"/><polygon fill="#A80036" points="817,2356.8409,807,2360.8409,817,2364.8409,813,2360.8409" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="813" y="2342.0319">mnesia_checkpoint:tm_exit_pending(Tid)</text><path d="M715,2373.8409 L715,2400.8409 L892,2400.8409 L892,2383.8409 L882,2373.8409 L715,2373.8409 " fill="#FBFB77" filter="url(#fr9oizoz0xu4c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M882,2373.8409 L882,2383.8409 L892,2383.8409 L882,2373.8409 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="721" y="2392.738">Update the Lamport clock</text><!--MD5=[ff5913543076c3c58feddb2c063b41e8]
@startuml
box "Original node" #White
  participant tx as tx
  participant mnesia_tm as tm
  participant mnesia_locker as locker
  participant mnesia_recover as recover
end box

box "Participant A" #LightBlue
  participant mnesia_tm as tm_a
  participant mnesia_locker as locker_a
end box

tx -> tx ++ : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1094 mnesia_tm:t_commit]]
  tx -> tx : mnesia_tm:intercept_friends

  tx -> tx : mnesia_tm:arrange

  tx -> tx ++ : mnesia_tm:multi_commit(Prep)
    note over tx : Mnesia has 4 different commit protocols.\nWe only consider [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1380 sym_trans]] here.

    tx -> tx ++ : mnesia_tm:commit_nodes
      note over tx : Get list of nodes that contain\ndisk and ram copies\nof tables affected by\nthe transaction
    return {DiskNs, RamNs}

    tx -> tx : mnesia_checkpoint:tm_enter_pending

== 1st phase of 2PC ==
    tx -> tx ++ : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2071 mnesia_tm:ask_commit]]
      loop for each #commit record in #prep
        tx -\ tm_a : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L248 ask_commit]]
        tm_a -> tm_a : mnesia_checkpoint:tm_enter_pending
        tx /- tm_a : {vote_yes, Tid}

        tm_a -> tm_a : Add commit record from tx\nto the state gb_tree
      end
    return {WaitFor, Local}

    tx -> tx : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L2097 receive nodes' votes and derive outcome]]

== 2nd phase of 2PC ==
    note over tx : broadcast the outcome to\n the participants
    loop for each participant node
        tx -\ tm_a : {Tid, Outcome = do_commit}
        note over tm_a : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L273 doit_loop]]
        note over tm_a : lookup #participant record\n from the state gb_tree
    end

    tx -> tx : mnesia_recover:note_decision(Tid, committed)

    tx -> tx ++ : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L1777 mnesia_tm:do_dirty]]
      note over tx: Mnesia logs #commit record\nfor the local node.\nSee "Arrange" chapter below
      tx -> tx : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_log.erl#L227 mnesia_log:log]](#commit{})

        tm_a -> tm_a : mnesia_log:log(Commit)
        tm_a -> tm_a : mnesia_recover:note_decision(Tid, committed)

== Post-commit actions ==
      tx -> tx ++ : mnesia_tm:do_commit
        note over tx: Dump the ops to the DB,\n notify subscribers,\n etc.
        tx -> tx : mnesia_tm:do_snmp
        tx -> tx : update_ram_copies
        tx -> tx : update_disc_copies
        tx -> tx : mnesia_tm:do_update_ext
        tx -> tx : mnesia_subscr:report_activity
      return ?
    return ?

    tm_a -> tm_a : mnesia_tm:do_commit(Tid, Commit)

== Cleanup ==
    tx -> locker : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183 release_tid]]
    tm_a -> locker_a : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_locker.erl#L183 release_tid]]


    tx -\ tm : [[https://github.com/erlang/otp/blob/OTP-24.0/lib/mnesia/src/mnesia_tm.erl#L377 delete_transaction]]
  return do_commit
return do_commit

group remote cleanup
    tm_a -> tm_a : mnesia_tm:transaction_terminated
    tm_a -> tm_a : mnesia_checkpoint:tm_exit_pending(Tid)
    note over tm_a: Update the Lamport clock
end
@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.11+9-Ubuntu-0ubuntu2.20.10
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>